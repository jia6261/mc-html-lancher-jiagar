<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Multi-Launcher Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=JetBrains+Mono&display=swap');
        
        :root {
            --mc-blue: #3b82f6;
            --mc-bg: #0a0a0b;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--mc-bg);
            color: #e2e8f0;
            background-image: radial-gradient(circle at 2px 2px, #1a1a1a 1px, transparent 0);
            background-size: 40px 40px;
        }

        .glass-panel {
            background: rgba(18, 18, 20, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        .source-card, .version-card {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .source-card.active, .version-card.active {
            border: 2px solid var(--mc-blue) !important;
            background: rgba(59, 130, 246, 0.08) !important;
        }

        /* æ¨¡æ‹Ÿåƒç´ è¾¹æ¡†åŠ¨ç”» */
        .launch-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .launch-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }

        .launch-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input, select {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #fff !important;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-4xl rounded-2xl overflow-hidden flex flex-col md:flex-row h-[650px]">
        
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="w-16 md:w-20 bg-black/40 border-r border-white/5 flex flex-col items-center py-6 gap-8">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <nav class="flex flex-col gap-6">
                <button onclick="switchTab('main')" class="text-blue-500 hover:scale-110 transition-transform"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></button>
                <button onclick="switchTab('settings')" class="text-slate-500 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg></button>
            </nav>
        </div>

        <!-- ä¸­é—´å†…å®¹åŒº -->
        <div id="tab-main" class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- è´¦æˆ·ä¸è®¾ç½® -->
            <div class="w-full md:w-1/2 p-8 border-r border-white/5 flex flex-col">
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-blue-400 tracking-widest uppercase">èº«ä»½éªŒè¯</h2>
                        <span id="auth-tag" class="text-[9px] bg-white/10 px-2 py-0.5 rounded text-slate-400">ç¦»çº¿æ¨¡å¼</span>
                    </div>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button onclick="handleMicrosoftAuth()" class="flex-1 py-2.5 bg-blue-600/10 hover:bg-blue-600/20 border border-blue-500/30 rounded-lg text-xs font-bold transition-all">Microsoft ç™»å½•</button>
                            <button onclick="toggleOffline()" class="px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-xs">åˆ‡æ¢ç¦»çº¿</button>
                        </div>
                        <div id="offline-input-group">
                            <input type="text" id="username" placeholder="è¾“å…¥ç©å®¶ ID" class="w-full px-4 py-2.5 rounded-lg text-sm outline-none focus:border-blue-500/50">
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xs font-bold text-blue-400 mb-4 tracking-widest uppercase">èµ„æºä¸‹è½½æº</h2>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div id="src-mojang" onclick="setSource('mojang')" class="source-card active p-2 rounded-lg border border-white/5 cursor-pointer">
                            <div class="text-[10px] font-bold">Mojang</div>
                            <div class="text-[8px] text-slate-500">å®˜æ–¹</div>
                        </div>
                        <div id="src-bmcl" onclick="setSource('bmcl')" class="source-card p-2 rounded-lg border border-white/5 cursor-pointer">
                            <div class="text-[10px] font-bold">BMCLAPI</div>
                            <div class="text-[8px] text-slate-500">é•œåƒ</div>
                        </div>
                        <div id="src-bbs" onclick="setSource('bbs')" class="source-card p-2 rounded-lg border border-white/5 cursor-pointer">
                            <div class="text-[10px] font-bold">BBSMC</div>
                            <div class="text-[8px] text-slate-500">å›½å†…</div>
                        </div>
                    </div>
                </div>

                <div class="mt-auto p-4 bg-blue-500/5 rounded-xl border border-blue-500/10">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center"><svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <div class="text-[10px] leading-relaxed">
                            æ— åç«¯æ¨¡å¼å·²å¯ç”¨ã€‚é…ç½®æ–‡ä»¶å°†æš‚å­˜åœ¨æµè§ˆå™¨ IndexedDB ä¸­ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯åŠ¨ä¸çŠ¶æ€ -->
            <div class="w-full md:w-1/2 p-8 bg-black/20 flex flex-col">
                <div class="flex justify-between items-start mb-10">
                    <div>
                        <h1 class="text-2xl font-bold text-white">READY TO PLAY</h1>
                        <p id="bridge-status" class="text-[10px] text-red-500 font-mono">BRIDGE DISCONNECTED</p>
                    </div>
                    <button onclick="syncGlobalConfig()" class="p-2 bg-white/5 rounded-lg hover:bg-white/10 transition-colors">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div id="ver-java" onclick="selectVersion('java')" class="version-card active p-5 rounded-2xl cursor-pointer flex items-center gap-5">
                        <div class="text-3xl">â˜•</div>
                        <div>
                            <div class="text-sm font-bold">Java Edition</div>
                            <div class="text-[10px] text-slate-500">æœ€é«˜æ”¯æŒ 1.20.4 (OptiFine)</div>
                        </div>
                    </div>
                    <div id="ver-bedrock" onclick="selectVersion('bedrock')" class="version-card p-5 rounded-2xl cursor-pointer flex items-center gap-5">
                        <div class="text-3xl">ğŸ§Š</div>
                        <div>
                            <div class="text-sm font-bold">Bedrock Edition</div>
                            <div class="text-[10px] text-slate-500">Windows Store åè®®è°ƒèµ·</div>
                        </div>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="flex justify-between mb-2">
                        <span id="status-text" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">ç³»ç»Ÿå¾…å‘½</span>
                        <span id="percent-text" class="text-[10px] font-mono text-slate-400 tracking-tighter">0%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden mb-6">
                        <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-700 w-0 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                    </div>

                    <button id="launch-btn" onclick="handleLaunch()" class="launch-btn w-full bg-white text-black py-4 rounded-xl font-bold text-lg">
                        å¼€å§‹å†’é™©
                    </button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ (éšè—) -->
        <div id="tab-settings" class="hidden flex-1 p-10 overflow-y-auto">
            <h2 class="text-2xl font-bold mb-8">å¯åŠ¨å™¨è®¾ç½®</h2>
            <div class="space-y-8 max-w-xl">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-slate-500 mb-2 font-bold uppercase">JVM å†…å­˜åˆ†é… (MB)</label>
                        <input type="number" id="jvm-memory" value="4096" class="w-full px-4 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-2 font-bold uppercase">Java è·¯å¾„</label>
                        <input type="text" id="java-path" value="Default" class="w-full px-4 py-2 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-slate-500 mb-2 font-bold uppercase">è°ƒè¯•æ¨¡å¼</label>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="debug-mode" class="w-4 h-4 rounded bg-white/10">
                        <span class="text-sm">åœ¨å¯åŠ¨æ—¶æ‰“å¼€æ§åˆ¶å°çª—å£</span>
                    </div>
                </div>
                <button onclick="switchTab('main')" class="px-6 py-2 bg-blue-600 rounded-lg text-sm font-bold">ä¿å­˜å¹¶è¿”å›</button>
            </div>
        </div>
    </div>

    <!-- è¿·ä½ æ—¥å¿—æµ®å±‚ -->
    <div id="mini-log" class="fixed bottom-6 right-6 w-72 bg-black/90 rounded-xl border border-white/10 p-4 font-mono text-[10px] text-slate-400 hidden shadow-2xl">
        <div class="flex justify-between items-center mb-2 border-b border-white/5 pb-1">
            <span class="text-blue-500 font-bold tracking-tighter">TERMINAL</span>
            <button onclick="this.parentElement.parentElement.classList.add('hidden')" class="hover:text-white">Ã—</button>
        </div>
        <div id="log-content" class="h-32 overflow-y-auto space-y-1"></div>
    </div>

    <script>
        const API_BASE = "http://localhost:8080";
        let state = {
            version: 'java',
            source: 'mojang',
            isLocalhost: false,
            isAuth: false,
            user: null
        };

        // --- å…¨åŠŸèƒ½åˆå§‹åŒ– ---
        window.addEventListener('DOMContentLoaded', async () => {
            writeLog("æ ¸å¿ƒæ¨¡å—åˆå§‹åŒ–ä¸­...");
            await checkConnection();
            // å·²ç§»é™¤æœªå®šä¹‰çš„ initUI() è°ƒç”¨ï¼Œæ”¹ä¸ºç›´æ¥æ‰§è¡Œåˆå§‹åŒ–æ—¥å¿—
            writeLog("UI æ¸²æŸ“å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æŒ‡ä»¤ã€‚");
        });

        async function checkConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const res = await fetch(`${API_BASE}/ping`, { signal: controller.signal }).catch(() => null);
                clearTimeout(timeoutId);

                if (res && res.ok) {
                    state.isLocalhost = true;
                    const badge = document.getElementById('bridge-status');
                    badge.innerText = "LOCAL BRIDGE CONNECTED";
                    badge.className = "text-[10px] text-green-500 font-mono";
                    writeLog("å·²æ£€æµ‹åˆ°æœ¬åœ° C++ åç«¯è¿›ç¨‹ã€‚");
                } else {
                    writeLog("æœªæ£€æµ‹åˆ°åç«¯ï¼Œå¯ç”¨å¤‡ç”¨æµè§ˆå™¨åè®®ã€‚");
                }
            } catch (e) {
                writeLog("åç«¯è¿æ¥å°è¯•å¤±è´¥ã€‚");
            }
        }

        function writeLog(msg) {
            const logPanel = document.getElementById('mini-log');
            const logContent = document.getElementById('log-content');
            if (!logPanel || !logContent) return;
            
            logPanel.classList.remove('hidden');
            const div = document.createElement('div');
            div.innerHTML = `<span class="text-slate-600">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logContent.appendChild(div);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // --- UI é€»è¾‘ ---
        function switchTab(tabId) {
            document.getElementById('tab-main').classList.toggle('hidden', tabId !== 'main');
            document.getElementById('tab-settings').classList.toggle('hidden', tabId !== 'settings');
        }

        function setSource(src) {
            state.source = src;
            document.querySelectorAll('.source-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`src-${src}`);
            if (activeCard) activeCard.classList.add('active');
            writeLog(`åˆ‡æ¢ä¸‹è½½æºè‡³é•œåƒ: ${src.toUpperCase()}`);
        }

        function selectVersion(v) {
            state.version = v;
            document.querySelectorAll('.version-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`ver-${v}`);
            if (activeCard) activeCard.classList.add('active');
            writeLog(`é€‰æ‹©æ¸¸æˆç‰ˆæœ¬: ${v.toUpperCase()}`);
        }

        function toggleOffline() {
            state.isAuth = false;
            document.getElementById('auth-tag').innerText = "ç¦»çº¿æ¨¡å¼";
            writeLog("åˆ‡æ¢åˆ°ç¦»çº¿ç™»å½•æ¨¡å¼ã€‚");
        }

        // --- æ ¸å¿ƒåŠŸèƒ½è¯·æ±‚ ---
        async function handleMicrosoftAuth() {
            if (!state.isLocalhost) {
                writeLog("[WARN] æ— åç«¯æ¨¡å¼æ— æ³•è¿›è¡Œå¾®è½¯ç™»å½•ã€‚");
                return alert("è¯·å…ˆè¿è¡Œæœ¬åœ°æ¡¥æ¥å™¨ä»¥å¤„ç† OAuthã€‚");
            }
            writeLog("æ­£åœ¨è¯·æ±‚æœ¬åœ° C++ å¼€å¯å¾®è½¯ç™»å½•éªŒè¯...");
            try {
                const res = await fetch(`${API_BASE}/auth/microsoft`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    state.isAuth = true;
                    state.user = data.user;
                    document.getElementById('username').value = data.user.name;
                    document.getElementById('auth-tag').innerText = "æ­£ç‰ˆå·²ç™»å½•";
                    writeLog(`æ¬¢è¿å›æ¥, ${data.user.name}!`);
                }
            } catch (e) {
                writeLog("è®¤è¯è¿‡ç¨‹è¶…æ—¶æˆ–è¢«å–æ¶ˆã€‚");
            }
        }

        async function syncGlobalConfig() {
            writeLog("æ­£åœ¨ä»äº‘ç«¯æ‹‰å–ç‰ˆæœ¬æ¸…å•...");
            updateUI("åŒæ­¥ä¸­", "æ­£åœ¨è§£æ JSON ç´¢å¼•...", 40);
            
            const url = "https://launchermeta.mojang.com/mc/game/version_manifest.json";
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Network response was not ok");
                const data = await res.json();
                writeLog(`åŒæ­¥æˆåŠŸ: å·²è·å– ${data.versions.length} ä¸ªç‰ˆæœ¬ä¿¡æ¯ã€‚`);
                updateUI("å°±ç»ª", "é…ç½®åŒæ­¥å®Œæˆ", 100);
                
                setTimeout(() => updateUI("ç³»ç»Ÿå¾…å‘½", "0%", 0), 2000);
            } catch (e) {
                writeLog(`åŒæ­¥å¤±è´¥: ${e.message}ã€‚å°†ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚`);
                updateUI("åŒæ­¥å¤±è´¥", "ç½‘ç»œè¿æ¥å¼‚å¸¸", 0);
            }
        }

        async function handleLaunch() {
            const btn = document.getElementById('launch-btn');
            btn.disabled = true;
            updateUI("åˆå§‹åŒ–", "æ­£åœ¨æ„å»ºå¯åŠ¨å‘½ä»¤å‚æ•°...", 10);

            const payload = {
                version: state.version,
                source: state.source,
                username: document.getElementById('username').value || "Player",
                memory: document.getElementById('jvm-memory').value,
                isAuth: state.isAuth
            };

            if (state.version === 'bedrock') {
                writeLog("æ­£åœ¨å”¤é†’ Windows å•†åº—åŸºå²©ç‰ˆåè®® (minecraft://)...");
                window.location.href = "minecraft://";
                updateUI("è¿è¡Œä¸­", "åè®®å·²å‘é€", 100);
                setTimeout(() => { 
                    btn.disabled = false;
                    updateUI("ç³»ç»Ÿå¾…å‘½", "0%", 0);
                }, 3000);
            } else {
                if (!state.isLocalhost) {
                    writeLog("[FAIL] Java ç‰ˆéœ€è¦ C++ æƒé™è°ƒèµ·æœ¬åœ° JVM ç¯å¢ƒã€‚");
                    updateUI("æ— æ³•å¯åŠ¨", "åç«¯æœªè¿æ¥", 0);
                    btn.disabled = false;
                    return;
                }
                
                try {
                    writeLog("å‘é€å¯åŠ¨æŒ‡ä»¤è‡³åç«¯...");
                    const res = await fetch(`${API_BASE}/launch`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (res.ok) {
                        updateUI("æˆåŠŸ", "Java è¿›ç¨‹å·²åœ¨åå°è°ƒèµ·", 100);
                        writeLog("[SUCCESS] æ¸¸æˆå·²æ‹‰èµ·ã€‚");
                    } else {
                        throw new Error("åç«¯æ‰§è¡Œå¤±è´¥");
                    }
                } catch (e) {
                    writeLog(`[ERROR] å¯åŠ¨å¤±è´¥: ${e.message}`);
                    updateUI("é€šä¿¡é”™è¯¯", "è¯·æ±‚è¶…æ—¶", 0);
                }
                btn.disabled = false;
            }
        }

        function updateUI(status, detail, p) {
            const sText = document.getElementById('status-text');
            const pText = document.getElementById('percent-text');
            const pBar = document.getElementById('progress-bar');
            
            if (sText) sText.innerText = status;
            if (pText) pText.innerText = typeof p === 'number' ? p + "%" : p;
            if (pBar) pBar.style.width = p + "%";
        }
    </script>
</body>
</html>
